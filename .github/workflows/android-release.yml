name: ðŸš€ Android Release Build

# Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ push Ð² main Ð²ÐµÑ‚ÐºÑƒ
on:
  push:
    branches: [ main ]
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4096m -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  build-and-release:
    name: ðŸ“± Build & Release APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð½Ð¾ÑÑ‚Ð¸

      # 2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Java
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Gradle Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      - name: ðŸ“¦ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      # 4. ÐŸÑ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ gradlew
      - name: ðŸ”§ Make gradlew executable
        run: chmod +x gradlew

      # 5. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      - name: ðŸ§¹ Clean Project
        run: ./gradlew clean

      # 6. Ð¡Ð±Ð¾Ñ€ÐºÐ° Release APK
      - name: ðŸ”¨ Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      # 7. ÐŸÐ¾Ð´Ð¿Ð¸ÑÑŒ APK Ñ debug keystore
      - name: âœï¸ Sign APK with Debug Keystore
        run: |
          echo "ðŸ“ Signing APK with debug keystore..."
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ debug keystore ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
          if [ ! -f ~/.android/debug.keystore ]; then
            mkdir -p ~/.android
            keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi
          # ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ APK
          $ANDROID_HOME/build-tools/*/apksigner sign --ks ~/.android/debug.keystore --ks-key-alias androiddebugkey --ks-pass pass:android --key-pass pass:android --out app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/app-release-unsigned.apk
          echo "âœ… APK signed successfully"

      # 8. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð²ÐµÑ€ÑÐ¸Ð¸ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²
      - name: ðŸ·ï¸ Generate Version Number
        id: version
        run: |
          # Ð’ÐµÑ€ÑÐ¸Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°: v1.0.BUILD_NUMBER
          BUILD_NUMBER=$(git rev-list --count HEAD)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION="v1.0.${BUILD_NUMBER}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Version: ${VERSION} (Build: ${BUILD_NUMBER}, Commit: ${COMMIT_HASH})"

      # 9. ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ APK Ñ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹
      - name: ðŸ“ Rename APK with Version
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          NEW_NAME="SpeedWorkshop-${{ steps.version.outputs.version }}-${{ steps.version.outputs.commit_hash }}.apk"
          cp "${APK_PATH}" "${NEW_NAME}"
          echo "âœ… APK renamed to: ${NEW_NAME}"
          echo "APK_NAME=${NEW_NAME}" >> $GITHUB_ENV

      # 10. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° APK
      - name: ðŸ“Š Check APK Size
        run: |
          APK_SIZE=$(du -h "${APK_NAME}" | cut -f1)
          echo "ðŸ“¦ APK Size: ${APK_SIZE}"
          echo "APK_SIZE=${APK_SIZE}" >> $GITHUB_ENV

      # 11. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Release Notes
      - name: ðŸ“‹ Generate Release Notes
        run: |
          cat > release_notes.md << EOF
          ## ðŸš€ Speed Workshop Android App - ${{ steps.version.outputs.version }}
          
          ### ðŸ“± App Information
          - **Version:** ${{ steps.version.outputs.version }}
          - **Build:** ${{ steps.version.outputs.build_number }}
          - **Commit:** ${{ steps.version.outputs.commit_hash }}
          - **APK Size:** ${APK_SIZE}
          - **Built:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ðŸ“‹ Recent Changes
          $(git log --oneline -5 --pretty=format:"- %s (%h)")
          
          ### ðŸ”§ Technical Details
          - **Min SDK:** 24 (Android 7.0)
          - **Target SDK:** 34 (Android 14)
          - **Architecture:** Universal APK
          - **Signed with:** Debug keystore
          
          ### ðŸ“¥ Installation
          1. Download the APK file below
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          4. Enjoy the app! ðŸŽ‰
          
          ---
          
          **ðŸ¤– Automatically built by GitHub Actions**
          EOF
          
          echo "âœ… Release notes generated"

      # 12. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ GitHub Release
      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "ðŸš€ Speed Workshop ${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          files: ${{ env.APK_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° APK ÐºÐ°Ðº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ (Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾)
      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: speed-workshop-${{ steps.version.outputs.version }}
          path: ${{ env.APK_NAME }}
          retention-days: 30

      # 14. Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ
      - name: âœ… Build Summary
        run: |
          echo "ðŸŽ‰ =================================="
          echo "ðŸš€ BUILD COMPLETED SUCCESSFULLY!"
          echo "ðŸŽ‰ =================================="
          echo ""
          echo "ðŸ“± App: Speed Workshop Android"
          echo "ðŸ·ï¸ Version: ${{ steps.version.outputs.version }}"
          echo "ðŸ“¦ APK: ${APK_NAME}"
          echo "ðŸ“Š Size: ${APK_SIZE}"
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "âœ… Release created and APK uploaded!"
          echo "ðŸŽ‰ ==================================" 