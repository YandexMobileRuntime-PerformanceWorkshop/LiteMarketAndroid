name: ðŸš€ Android Release Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4096m -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  build-and-release:
    name: ðŸ“± Build & Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“¦ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: ðŸ”§ Make gradlew executable
        run: chmod +x gradlew

      - name: ðŸ§¹ Clean Project
        run: ./gradlew clean

      - name: ðŸ”¨ Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      - name: ðŸ·ï¸ Generate Version Number
        id: version
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION="v1.0.${BUILD_NUMBER}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Version: ${VERSION} (Build: ${BUILD_NUMBER}, Commit: ${COMMIT_HASH})"

      - name: ðŸ“ Rename APK with Version
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          NEW_NAME="SpeedWorkshop-${{ steps.version.outputs.version }}-${{ steps.version.outputs.commit_hash }}.apk"
          cp "${APK_PATH}" "${NEW_NAME}"
          echo "âœ… APK renamed to: ${NEW_NAME}"
          echo "APK_NAME=${NEW_NAME}" >> $GITHUB_ENV

      - name: ðŸ“Š Check APK Size
        run: |
          APK_SIZE=$(du -h "${APK_NAME}" | cut -f1)
          echo "ðŸ“¦ APK Size: ${APK_SIZE}"
          echo "APK_SIZE=${APK_SIZE}" >> $GITHUB_ENV

      - name: ðŸ“‹ Generate Release Notes
        run: |
          cat > release_notes.md << RELEASE_EOF
          ## ðŸš€ Speed Workshop Android App - ${{ steps.version.outputs.version }}
          
          ### ðŸ“± App Information
          - **Version:** ${{ steps.version.outputs.version }}
          - **Build:** ${{ steps.version.outputs.build_number }}
          - **Commit:** ${{ steps.version.outputs.commit_hash }}
          - **APK Size:** ${APK_SIZE}
          - **Built:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ðŸ“‹ Recent Changes
          $(git log --oneline -5 --pretty=format:"- %s (%h)")
          
          ### ðŸ”§ Technical Details
          - **Min SDK:** 24 (Android 7.0)
          - **Target SDK:** 34 (Android 14)
          - **Architecture:** Universal APK
          - **Signed with:** Debug keystore
          
          ### ðŸ“¥ Installation
          1. Download the APK file below
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          4. Enjoy the app! ðŸŽ‰
          
          ---
          **ðŸ¤– Automatically built by GitHub Actions**
          RELEASE_EOF

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "ðŸš€ Speed Workshop ${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          files: ${{ env.APK_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: speed-workshop-${{ steps.version.outputs.version }}
          path: ${{ env.APK_NAME }}
          retention-days: 30

      - name: âœ… Build Summary
        run: |
          echo "ðŸŽ‰ =================================="
          echo "ðŸš€ BUILD COMPLETED SUCCESSFULLY!"
          echo "ðŸŽ‰ =================================="
          echo ""
          echo "ðŸ“± App: Speed Workshop Android"
          echo "ðŸ·ï¸ Version: ${{ steps.version.outputs.version }}"
          echo "ðŸ“¦ APK: ${APK_NAME}"
          echo "ðŸ“Š Size: ${APK_SIZE}"
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "âœ… Release created and APK uploaded!"
          echo "ðŸŽ‰ =================================="
